<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plist → XML Converter</title>
<style>
  body { font-family: monospace; padding: 20px; background: #f4f4f4; }
  textarea { width: 100%; height: 300px; margin-top: 10px; font-family: monospace; }
  input, button { margin-top: 10px; }
</style>
</head>
<body>
<h1>Plist → XML TextureAtlas Converter</h1>

<input type="file" id="plistFile" accept=".plist">
<br>
<button onclick="convertPlist()">Convert</button>
<br>
<textarea id="output" placeholder="XML output will appear here..."></textarea>

<!-- Load Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script>
let pyodideReady = false;
let pyodide = null;

// Load Pyodide
async function loadPyodideAndPackages() {
    pyodide = await loadPyodide();
    pyodideReady = true;
}
loadPyodideAndPackages();

async function convertPlist() {
    if (!pyodideReady) return alert("Pyodide is still loading. Please wait...");

    const fileInput = document.getElementById('plistFile');
    if (!fileInput.files.length) return alert('Select a plist file first.');

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = async function(e) {
        const plistData = e.target.result;
        try {
            // Pass plist content to Python
            pyodide.FS.writeFile("input.plist", new Uint8Array(plistData));

            const code = `
import plistlib
import xml.etree.ElementTree as ET

with open("input.plist", "rb") as f:
    plist = plistlib.load(f)

frames = plist.get("frames", {})
metadata = plist.get("metadata", {})
texture_file = metadata.get("realTextureFileName", "texture.png")

root = ET.Element("TextureAtlas", imagePath=texture_file)

for name, f in frames.items():
    rect = f["textureRect"].replace("{","").replace("}","").split(",")
    x, y, width, height = map(int, rect)

    source = f["spriteSourceSize"].replace("{","").replace("}","").split(",")
    frameWidth, frameHeight = map(int, source)

    offset = f["spriteOffset"].replace("{","").replace("}","").split(",")
    frameX, frameY = map(int, offset)

    ET.SubElement(root, "SubTexture",
                  name=name,
                  x=str(x), y=str(y), width=str(width), height=str(height),
                  frameX=str(frameX), frameY=str(frameY),
                  frameWidth=str(frameWidth), frameHeight=str(frameHeight))

import io
output = io.BytesIO()
ET.ElementTree(root).write(output, encoding="utf-8", xml_declaration=True)
output.getvalue().decode("utf-8")
`;
            const result = await pyodide.runPythonAsync(code);
            document.getElementById('output').value = result;
        } catch (err) {
            alert("Error converting plist: " + err);
        }
    };

    reader.readAsArrayBuffer(file);
}
</script>
</body>
</html>
